# Dependency Vulnerability Management Guide

## Overview

This guide provides comprehensive strategies for managing vulnerable dependencies in the Pivot CLI project, with focus on vulnerability detection, assessment, and remediation.

## Detection Tools

### Nancy OSS Index Scanner

Nancy is our primary tool for dependency vulnerability scanning:

```bash
# Install nancy
go install github.com/sonatype-nexus-community/nancy@latest

# Scan dependencies
go list -json -deps ./... | nancy sleuth

# Verbose output (includes non-vulnerable packages)
go list -json -deps ./... | nancy sleuth --loud
```

### Alternative Tools

- **go mod audit**: Built-in Go module security checking
- **govulncheck**: Official Go vulnerability checker
- **Snyk**: Commercial vulnerability scanner
- **OWASP Dependency Check**: Multi-language dependency scanner

## Vulnerability Assessment

### Severity Classification

1. **Critical**: Immediate action required
   - Active exploits in the wild
   - Remote code execution vulnerabilities
   - Authentication bypasses

2. **High**: Schedule for next release
   - Privilege escalation vulnerabilities
   - SQL injection, XSS in dependencies
   - Data exposure risks

3. **Medium**: Include in regular maintenance
   - Denial of service vulnerabilities
   - Information disclosure
   - Less severe security weaknesses

4. **Low**: Monitor and review
   - Potential security improvements
   - Theoretical vulnerabilities
   - Performance-related security issues

## Remediation Strategies

### 1. Dependency Updates

**Preferred approach for most vulnerabilities:**

```bash
# Update all dependencies
go get -u ./...

# Update specific dependency
go get -u github.com/example/package@latest

# Update to specific secure version
go get github.com/example/package@v1.2.3
```

**Testing after updates:**
```bash
# Run full test suite
make test-all

# Verify security improvements
make test-security

# Test specific functionality
make test-cli
```

### 2. Alternative Package Selection

**When updates aren't available:**

1. **Research alternatives**: Find packages with similar functionality
2. **Security assessment**: Evaluate alternative packages for security
3. **Migration planning**: Plan gradual migration to alternative
4. **Backward compatibility**: Ensure feature parity

**Example evaluation checklist:**
- [ ] Package maintenance status
- [ ] Security track record
- [ ] Community size and support
- [ ] Feature completeness
- [ ] Performance characteristics
- [ ] License compatibility

### 3. Vulnerability Acceptance (Controlled Risk)

**For false positives or low-risk vulnerabilities:**

```bash
# Add to ignore file with justification
echo "CVE-2023-12345 # False positive: affects only test environment" >> .nancy-ignore
```

**Acceptance criteria:**
- Vulnerability doesn't affect used functionality
- Workarounds or mitigations are in place
- Risk is acceptable for the application context
- Temporary acceptance with monitoring plan

### 4. Vendoring and Patching

**For critical dependencies with no secure alternatives:**

```bash
# Enable Go modules vendoring
go mod vendor

# Apply custom patches to vendored dependencies
# (patch files should be documented and version controlled)
```

**Documentation requirements:**
- Document all custom patches
- Version control patch files
- Update procedures for future versions
- Security review process

### 5. Isolation and Sandboxing

**Architectural approaches:**

1. **Process isolation**: Run vulnerable components in separate processes
2. **Container isolation**: Use containers to limit vulnerability impact
3. **Network segmentation**: Restrict network access for vulnerable components
4. **Permission restriction**: Limit filesystem and system access

## Vulnerability Tracking

### .nancy-ignore File Management

**Format:**
```
CVE-YYYY-NNNN # Detailed reason for ignoring
```

**Examples:**
```
CVE-2023-12345 # False positive: vulnerability in test-only dependency
CVE-2023-67890 # Accepted risk: affects unused JSON parsing functionality
CVE-2023-54321 # Temporary: waiting for upstream fix, mitigated by input validation
```

**Review process:**
1. Regular review of ignored vulnerabilities
2. Re-evaluate when dependency versions change
3. Remove from ignore list when fixes are available
4. Document business justification for long-term acceptances

### Vulnerability Database

**Maintain internal tracking:**

| CVE ID | Package | Severity | Status | Mitigation | Review Date |
|--------|---------|----------|---------|------------|-------------|
| CVE-2023-12345 | example/pkg | High | Patched | Updated to v2.1.0 | 2024-01-15 |
| CVE-2023-67890 | test/util | Low | Accepted | Test-only impact | 2024-02-01 |

### Regular Monitoring

**Scheduled activities:**

1. **Weekly**: Automated vulnerability scanning in CI
2. **Monthly**: Manual review of security reports
3. **Quarterly**: Review of ignored vulnerabilities
4. **Annually**: Comprehensive security audit

## Emergency Response Procedures

### Critical Vulnerability Discovery

**Immediate response (within 24 hours):**

1. **Assessment**: Evaluate impact on Pivot CLI
2. **Communication**: Notify team and stakeholders
3. **Temporary mitigation**: Implement workarounds if possible
4. **Update planning**: Plan emergency update if needed

**Response workflow:**
```bash
# 1. Immediate assessment
make test-security
./scripts/security-test.sh

# 2. Impact analysis
# Review affected functionality
# Test exploit scenarios
# Document findings

# 3. Mitigation
# Apply updates or workarounds
# Test thoroughly
# Deploy emergency fix

# 4. Verification
make test-all
./scripts/post-release-validation.sh
```

### Communication Templates

**Internal notification:**
```
SECURITY ALERT: Critical vulnerability in [package]

CVE: [CVE-ID]
Severity: [CRITICAL/HIGH]
Impact: [description]
Affected versions: [version range]
Mitigation: [immediate steps]
Timeline: [fix timeline]
```

**User notification (if applicable):**
```
Security Update Available: Pivot CLI v[version]

A security vulnerability has been discovered in a dependency.
Please update to the latest version:

brew upgrade pivot
# or download from releases page

Impact: [user-facing impact description]
Mitigation: [user actions if any]
```

## Automation and Integration

### CI/CD Integration

**GitHub Actions security workflow:**
```yaml
- name: Security scan
  run: |
    go install github.com/sonatype-nexus-community/nancy@latest
    make test-security
    
- name: Upload security report
  uses: actions/upload-artifact@v4
  with:
    name: security-reports
    path: |
      security-report.md
      nancy-vulnerability-report.txt
```

### Monitoring Setup

**Automated alerts:**
1. **Slack/Discord notifications** for new vulnerabilities
2. **Email alerts** for critical severity issues
3. **GitHub Issues** auto-creation for tracking
4. **Dashboard metrics** for security posture

### Dependency Management

**Go.mod best practices:**
```go
// Use specific versions for security
require (
    github.com/example/package v1.2.3
    // Avoid 'latest' for production dependencies
)

// Document security-related exclusions
exclude (
    github.com/vulnerable/package v1.0.0 // CVE-2023-12345
)
```

## Reporting and Documentation

### Security Reports

**Monthly security report template:**
1. **Executive Summary**: High-level security posture
2. **Vulnerability Summary**: New/resolved/ongoing vulnerabilities
3. **Risk Assessment**: Current security risk level
4. **Actions Taken**: Remediation activities
5. **Recommendations**: Proposed improvements

### Documentation Standards

**Required documentation:**
- Vulnerability assessment decisions
- Remediation steps and timelines
- Risk acceptance justifications
- Testing and validation procedures
- Emergency response actions

### Stakeholder Communication

**Regular updates to:**
- Development team (weekly)
- Project maintainers (monthly)
- Users (as needed for security releases)
- Security team (ongoing)

## Best Practices Summary

### Prevention
1. **Minimal dependencies**: Only include necessary packages
2. **Regular updates**: Monthly dependency review and updates
3. **Security-first selection**: Choose packages with good security records
4. **Version pinning**: Use specific versions rather than ranges

### Detection
1. **Automated scanning**: Integrate security tools in CI/CD
2. **Multiple tools**: Use complementary scanning approaches
3. **Regular audits**: Manual security reviews
4. **Community monitoring**: Follow security advisories

### Response
1. **Rapid assessment**: Quick impact evaluation procedures
2. **Clear communication**: Defined notification processes
3. **Tested procedures**: Regularly practiced response workflows
4. **Documentation**: Comprehensive record-keeping

### Recovery
1. **Thorough testing**: Comprehensive validation after fixes
2. **Rollback plans**: Quick reversion procedures if needed
3. **Lessons learned**: Post-incident analysis and improvement
4. **Preventive measures**: Process improvements to prevent recurrence

## Resources

### External Resources
- [NIST National Vulnerability Database](https://nvd.nist.gov/)
- [Go Security Policy](https://go.dev/security)
- [OSS Index](https://ossindex.sonatype.org/)
- [Snyk Vulnerability Database](https://snyk.io/vuln/)

### Internal Resources
- Pivot CLI Security Report: `security-report.md`
- Nancy Ignore File: `.nancy-ignore`
- Security Test Suite: `scripts/security-test.sh`
- Comprehensive Testing Guide: `docs/COMPREHENSIVE_TESTING.md`

---

This guide should be reviewed and updated regularly as security practices and tools evolve.
